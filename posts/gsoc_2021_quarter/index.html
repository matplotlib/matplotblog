<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>GSoC'21: Quarter Progress &#183; Matplotblog</title><meta name=description content="Quarter Progress with Google Summer of Code 2021 project under NumFOCUS: Aitik Gupta"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link href=https://matplotlib.org/matplotblog/css/concated.min.css rel=stylesheet><style>body{background:#ecedef url(https://matplotlib.org/matplotblog/bg_tiles.png)repeat}</style></head><body class=single-body><nav class="nav-bar side-padding"><h1 class=nav-header><a href=https://matplotlib.org/matplotblog/ class=nav-text><img src=https://matplotlib.org/matplotblog/mpl_logo.png></a></h1><a href=https://matplotlib.org/matplotblog/index.xml><img src=https://matplotlib.org/matplotblog/rss.svg style=width:25px;margin:10px alt="RSS feed"></a><div class=hamburger-menu><button onclick=hamburgerMenuPressed.call(this) aria-haspopup=true aria-expanded=false aria-controls=menu aria-label=Menu>
<span></span><span></span></button><ul id=menu class=hamburger-menu-overlay><li><a href=https://matplotlib.org/matplotblog/ class=hamburger-menu-overlay-link>Home</a></li><li><a href=https://matplotlib.org/matplotblog/posts/how-to-contribute/ class=hamburger-menu-overlay-link>How to Contribute</a></li><li><a href=https://matplotlib.org/matplotblog/categories/3d class=hamburger-menu-overlay-link>3d</a></li><li><a href=https://matplotlib.org/matplotblog/categories/academia class=hamburger-menu-overlay-link>Academia</a></li><li><a href=https://matplotlib.org/matplotblog/categories/art class=hamburger-menu-overlay-link>Art</a></li><li><a href=https://matplotlib.org/matplotblog/categories/editorial class=hamburger-menu-overlay-link>Editorial</a></li><li><a href=https://matplotlib.org/matplotblog/categories/graphs class=hamburger-menu-overlay-link>Graphs</a></li><li><a href=https://matplotlib.org/matplotblog/categories/gsoc class=hamburger-menu-overlay-link>Gsoc</a></li><li><a href=https://matplotlib.org/matplotblog/categories/gsod class=hamburger-menu-overlay-link>Gsod</a></li><li><a href=https://matplotlib.org/matplotblog/categories/industry class=hamburger-menu-overlay-link>Industry</a></li><li><a href=https://matplotlib.org/matplotblog/categories/news class=hamburger-menu-overlay-link>News</a></li><li><a href=https://matplotlib.org/matplotblog/categories/tutorials class=hamburger-menu-overlay-link>Tutorials</a></li><li><a href=https://matplotlib.org class=hamburger-menu-overlay-link target=blank>About</a></li></ul></div></nav><main class="content side-text-padding"><article class="post dropcase"><header class=post-header><h1 class=post-title>GSoC'21: Quarter Progress</h1><p class=post-date>Posted <time datetime=2021-08-03>Aug 3, 2021</time>
<span class=post-author>&mdash; By Aitik Gupta</span></p></header><picture class=post-figure>
<source srcset=https://matplotlib.org/matplotblog/posts/gsoc_2021_quarter/AitikGupta_GSoC_hua057dce2c5771caa80b3a5a6391d0947_295093_800x0_resize_lanczos_2.png><img src=https://matplotlib.org/matplotblog/posts/gsoc_2021_quarter/AitikGupta_GSoC_hua057dce2c5771caa80b3a5a6391d0947_295093_800x0_resize_lanczos_2.png></picture><p><strong>‚Äú<ins>Matplotlib, I want Â§ö‰∏™Ê±âÂ≠ó in between my text.</ins>‚Äù</strong></p><p>Let's say you asked Matplotlib to render a plot with some label containing Â§ö‰∏™Ê±âÂ≠ó (multiple Chinese characters) in between your English text.</p><p>Or conversely, let's say you use a Chinese font with Matplotlib, but you had English text in between (which is quite common).</p><blockquote><p>Assumption: the Chinese font doesn't have those English glyphs, and vice versa</p></blockquote><p>With this short writeup, I'll talk about how does a migration from a font-first to a text-first approach in Matplotlib looks like, which ideally solves the above problem.</p><h3 id=have-the-fonts>Have the fonts?</h3><p>Logically, the very first step to solving this would be to ask whether you <em>have</em> multiple fonts, right?</p><p>Matplotlib doesn't ship <a href=https://en.wikipedia.org/wiki/List_of_CJK_fonts>CJK</a> (Chinese Japanese Korean) fonts, which ideally contains these Chinese glyphs. It does try to cover most grounds with the <a href=https://matplotlib.org/stable/users/dflt_style_changes.html#normal-text>default font</a> it ships with, however.</p><p>So if you don't have a font to render your Chinese characters, go ahead and install one! Matplotlib will find your installed fonts (after rebuilding the cache, that is).</p><h3 id=parse-the-fonts>Parse the fonts</h3><p>This is where things get interesting, and what my <a href=https://matplotlib.org/matplotblog/posts/gsoc_2021_prequarter/>previous writeup</a> was all about..</p><blockquote><p>Parsing the whole family to get multiple fonts for given font properties</p></blockquote><h2 id=ft2font-magic>FT2Font Magic!</h2><p>To give you an idea about how things used to work for Matplotlib:</p><ol><li>A single font was chosen <em>at draw time</em>
(fixed: re <a href=(https://matplotlib.org/matplotblog/posts/gsoc_2021_prequarter/)>previous writeup</a>)</li><li>Every character displayed in your document was rendered by only that font
(partially fixed: re <ins>_this writeup_</ins>)</li></ol><blockquote><p>FT2Font is a matplotlib-to-font module, which provides high-level Python API to interact with a <em>single font's operations</em> like read/draw/extract/etc.</p></blockquote><p>Being written in C++, the module needs wrappers around it to be converted into a <a href=https://docs.python.org/3/extending/extending.html>Python extension</a> using Python's C-API.</p><blockquote><p>It allows us to use C++ functions directly from Python!</p></blockquote><p>So wherever you see a use of font within the library (by library I mean the readable Python codebase XD), you could have derived that:</p><pre><code>FT2Font === SingleFont
</code></pre><p>Things are be a bit different now however..</p><h2 id=designing-a-multi-font-system>Designing a multi-font system</h2><p>FT2Font is basically itself a wrapper around a library called <a href=https://www.freetype.org/>FreeType</a>, which is a freely available software library to render fonts.</p><p align=center><figure><img src=https://user-images.githubusercontent.com/43996118/128352387-76a3f52a-20fc-4853-b624-0c91844fc785.png alt="FT2Font Naming"><figcaption style=text-align:center;font-style:italic>How FT2Font was named</figcaption></figure></p><p>In my initial proposal.. while looking around how FT2Font is structured, I figured:</p><pre><code>Oh, looks like all we need are Faces!
</code></pre><blockquote><p>If you don't know what faces/glyphs/ligatures are, head over to why <a href=https://gankra.github.io/blah/text-hates-you/>Text Hates You</a>. I can guarantee you'll definitely enjoy some real life examples of why text rendering is hard. ü•≤</p></blockquote><p>Anyway, if you already know what Faces are, it might strike you:</p><p>If we already have all the faces we need from multiple fonts (let's say we created a child of FT2Font.. which only <ins>tracks the faces</ins> for its families), we should be able to render everything from that parent FT2Font right?</p><p>As I later figured out while finding segfaults in implementing this design:</p><pre><code>Each FT2Font is linked to a single FT_Library object!
</code></pre><p>If you tried to load the face/glyph/character (basically anything) from a different FT2Font object.. you'll run into serious segfaults. (because one object linked to an <code>FT_Library</code> can't really access another object which has it's own <code>FT_Library</code>)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#75715e>// face is linked to FT2Font; which is
</span><span style=color:#75715e></span><span style=color:#75715e>// linked to a single FT_Library object
</span><span style=color:#75715e></span>FT_Face face <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>get_face();
FT_Get_Glyph(face<span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>glyph, <span style=color:#f92672>&amp;</span>placeholder); <span style=color:#75715e>// works like a charm
</span><span style=color:#75715e></span>
<span style=color:#75715e>// somehow get another FT2Font&#39;s face
</span><span style=color:#75715e></span>FT_Face family_face <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>get_family_member()<span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>get_face();
FT_Get_Glyph(family_face<span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>glyph, <span style=color:#f92672>&amp;</span>placeholder); <span style=color:#75715e>// segfaults!
</span></code></pre></div><p>Realizing this took a good amount of time! After this I quickly came up with a recursive approach, wherein we:</p><ol><li>Create a list of FT2Font objects within Python, and pass it down to FT2Font</li><li>FT2Font will hold pointers to its families via a<br><code>std::vector&lt;FT2Font *> fallback_list</code></li><li>Find if the character we want is available in the current font<ol><li>If the character is available, use that FT2Font to render that character</li><li>If the character isn't found, go to step 3 again, but now iterate through the <code>fallback_list</code></li></ol></li><li>That's it!</li></ol><p>A quick overhaul of the above piece of code^</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>ft_get_glyph</span>(FT_Glyph <span style=color:#f92672>&amp;</span>placeholder) {
	FT_Error not_found <span style=color:#f92672>=</span> FT_Get_Glyph(<span style=color:#66d9ef>this</span><span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>get_face(), <span style=color:#f92672>&amp;</span>placeholder);
	<span style=color:#66d9ef>if</span> (not_found) <span style=color:#66d9ef>return</span> False;
	<span style=color:#66d9ef>else</span> <span style=color:#66d9ef>return</span> True;
}

<span style=color:#75715e>// within driver code
</span><span style=color:#75715e></span><span style=color:#66d9ef>for</span> (uint i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>; i<span style=color:#f92672>&lt;</span>fallback_list.size(); i<span style=color:#f92672>+</span><span style=color:#f92672>+</span>) {
	<span style=color:#75715e>// iterate through all FT2Font objects
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>bool</span> was_found <span style=color:#f92672>=</span> fallback_list[i]<span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span>ft_get_glyph(placeholder);
	<span style=color:#66d9ef>if</span> (was_found) <span style=color:#66d9ef>break</span>;
}
</code></pre></div><p>With the idea surrounding this implementation, the <a href=https://matplotlib.org/stable/api/backend_agg_api.html>Agg backend</a> is able to render a document (either through GUI, or a PNG) with multiple fonts!</p><p align=center><figure><img src=https://user-images.githubusercontent.com/43996118/128347495-1f4f858d-33d3-4119-8732-5b26c4e9ca2a.png alt=ChineseInBetween><figcaption style=text-align:center;font-style:italic>PNG straight outta Matplotlib!</figcaption></figure></p><h2 id=python-c-api-is-hard-at-first>Python C-API is hard, at first!</h2><p>I've spent days at Python C-API's <a href=https://docs.python.org/3/c-api/arg.html>argument doc</a>, and it's hard to get what you need at first, ngl.</p><p>But, with the help of some amazing people in the GSoC community (<a href=https://srijan-paul.github.io/>@srijan-paul</a>, <a href=https://atharvaraykar.me/>@atharvaraykar</a>) and amazing mentors, blockers begone!</p><h2 id=so-are-we-done>So are we done?</h2><p>Oh no. XD</p><p>Things work just fine for the Agg backend, but to generate a PDF/PS/SVG with multiple fonts is another story altogether! I think I'll save that for later.</p><p align=center><figure><img src=https://user-images.githubusercontent.com/43996118/128350093-13695b91-5ad2-4f96-91f5-8373ee7a189e.gif alt=ThankYouDwight><figcaption style=text-align:center;font-style:italic>If you've been following the progress so far, mayn you're awesome!</figcaption></figure></p><h4 id=note-this-blog-post-is-also-available-at-my-personal-websitehttpsaitikguptagithubiogsoc-quarter>NOTE: This blog post is also available at my <a href=https://aitikgupta.github.io/gsoc-quarter/>personal website</a>.</h4></article></main><nav class="end-nav side-padding"></nav><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous onload=renderMathInElement(document.body);></script><script src=https://matplotlib.org/matplotblog/js/core.min.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>