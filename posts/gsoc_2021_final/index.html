<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>GSoC'21: Final Report &#183; Matplotblog</title><meta name=description content="Google Summer of Code 2021: Final Report - Aitik Gupta"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link href=https://matplotlib.org/matplotblog/css/concated.min.css rel=stylesheet><style>body{background:#ecedef url(https://matplotlib.org/matplotblog/bg_tiles.png)repeat}</style></head><body class=single-body><nav class="nav-bar side-padding"><h1 class=nav-header><a href=https://matplotlib.org/matplotblog/ class=nav-text><img src=https://matplotlib.org/matplotblog/mpl_logo.png></a></h1><a href=https://matplotlib.org/matplotblog/index.xml><img src=https://matplotlib.org/matplotblog/rss.svg style=width:25px;margin:10px alt="RSS feed"></a><div class=hamburger-menu><button onclick=hamburgerMenuPressed.call(this) aria-haspopup=true aria-expanded=false aria-controls=menu aria-label=Menu>
<span></span><span></span></button><ul id=menu class=hamburger-menu-overlay><li><a href=https://matplotlib.org/matplotblog/ class=hamburger-menu-overlay-link>Home</a></li><li><a href=https://matplotlib.org/matplotblog/posts/how-to-contribute/ class=hamburger-menu-overlay-link>How to Contribute</a></li><li><a href=https://matplotlib.org/matplotblog/categories/3d class=hamburger-menu-overlay-link>3d</a></li><li><a href=https://matplotlib.org/matplotblog/categories/academia class=hamburger-menu-overlay-link>Academia</a></li><li><a href=https://matplotlib.org/matplotblog/categories/art class=hamburger-menu-overlay-link>Art</a></li><li><a href=https://matplotlib.org/matplotblog/categories/editorial class=hamburger-menu-overlay-link>Editorial</a></li><li><a href=https://matplotlib.org/matplotblog/categories/graphs class=hamburger-menu-overlay-link>Graphs</a></li><li><a href=https://matplotlib.org/matplotblog/categories/gsoc class=hamburger-menu-overlay-link>Gsoc</a></li><li><a href=https://matplotlib.org/matplotblog/categories/gsod class=hamburger-menu-overlay-link>Gsod</a></li><li><a href=https://matplotlib.org/matplotblog/categories/industry class=hamburger-menu-overlay-link>Industry</a></li><li><a href=https://matplotlib.org/matplotblog/categories/news class=hamburger-menu-overlay-link>News</a></li><li><a href=https://matplotlib.org/matplotblog/categories/tutorials class=hamburger-menu-overlay-link>Tutorials</a></li><li><a href=https://matplotlib.org class=hamburger-menu-overlay-link target=blank>About</a></li></ul></div></nav><main class="content side-text-padding"><article class="post dropcase"><header class=post-header><h1 class=post-title>GSoC'21: Final Report</h1><p class=post-date>Posted <time datetime=2021-08-17>Aug 17, 2021</time>
<span class=post-author>&mdash; By Aitik Gupta</span></p></header><picture class=post-figure>
<source srcset=https://matplotlib.org/matplotblog/posts/gsoc_2021_final/AitikGupta_GSoC_hu1f4d8e75d51824a2dad9c95c548d0de7_311761_800x0_resize_lanczos_2.png><img src=https://matplotlib.org/matplotblog/posts/gsoc_2021_final/AitikGupta_GSoC_hu1f4d8e75d51824a2dad9c95c548d0de7_311761_800x0_resize_lanczos_2.png></picture><p><strong><ins>Matplotlib: Revisiting Text/Font Handling</ins></strong></p><p>To kick things off for the final report, here's a <a href=https://user-images.githubusercontent.com/43996118/129448683-bc136398-afeb-40ac-bbb7-0576757baf3c.jpg>meme</a> to nudge about the <a href=https://matplotlib.org/matplotblog/categories/gsoc/>previous blogs</a>.</p><h2 id=about-matplotlib>About Matplotlib</h2><p>Matplotlib is a comprehensive library for creating static, animated, and interactive visualizations, which has become a <em>de-facto Python plotting library</em>.</p><p>Much of the implementation behind its font manager is inspired by <a href=https://www.w3.org/>W3C</a> compliant algorithms, allowing users to interact with font properties like <code>font-size</code>, <code>font-weight</code>, <code>font-family</code>, etc.</p><h4 id=however-the-way-matplotlib-handled-fonts-and-general-text-layout-was-not-ideal-which-is-what-summer-2021-was-all-about>However, the way Matplotlib handled fonts and general text layout was not ideal, which is what Summer 2021 was all about.</h4><blockquote><p>By &ldquo;not ideal&rdquo;, I do not mean that the library has design flaws, but that the design was engineered in the early 2000s, and is now <em>outdated</em>.</p></blockquote><p>(..more on this later)</p><h3 id=about-the-project>About the Project</h3><p>(PS: here's <a href="https://docs.google.com/document/d/11PrXKjMHhl0rcQB4p_W9JY_AbPCkYuoTT0t85937nB0/view#heading=h.feg5pv3x59u2">the link</a> to my GSoC proposal, if you're interested)</p><p>Overall, the project was divided into two major subgoals:</p><ol><li>Font Subsetting</li><li>Font Fallback</li></ol><p>But before we take each of them on, we should get an idea about some basic terminology for fonts (which are a <em>lot</em>, and are rightly <em>confusing</em>)</p><p>The <a href=https://github.com/matplotlib/matplotlib/pull/20346/files>PR: Clarify/Improve docs on family-names vs generic-families</a> brings about a bit of clarity about some of these terms. The next section has a linked PR which also explains the types of fonts and how that is relevant to Matplotlib.</p><h2 id=font-subsetting>Font Subsetting</h2><p>An easy-to-read guide on Fonts and Matplotlib was created with <a href=https://github.com/matplotlib/matplotlib/pull/20450>PR: [Doc] Font Types and Font Subsetting</a>, which is currently live at <a href=https://matplotlib.org/devdocs/users/fonts.html>Matplotlib's DevDocs</a>.</p><p>Taking an excerpt from one of my previous blogs (and <a href=https://matplotlib.org/devdocs/users/fonts.html#subsetting>the doc</a>):</p><blockquote><p>Fonts can be considered as a collection of these glyphs, so ultimately the goal of subsetting is to find out which glyphs are <ins>required</ins> for a certain array of characters, and embed <ins>only those</ins> within the output.</p></blockquote><p>PDF, PS/EPS and SVG output document formats are special, as in <strong>the text within them can be <ins>editable</ins></strong>, i.e, one can copy/search text from documents (for eg, from a PDF file) if the text is editable.</p><h3 id=matplotlib-and-subsetting>Matplotlib and Subsetting</h3><p>The PDF, PS/EPS and SVG backends used to support font subsetting, <em>only for a few types</em>. What that means is, before Summer &lsquo;21, Matplotlib could generate Type 3 subsets for PDF, PS/EPS backends, but it <ins><em>could not</em></ins> generate Type 42 / TrueType subsets.</p><p>With <a href=https://github.com/matplotlib/matplotlib/pull/20391>PR: Type42 subsetting in PS/PDF</a> merged in, users can expect their PDF/PS/EPS documents to contains subsetted glyphs from the original fonts.</p><p>This is especially benefitial for people who wish to use <ins>commercial</ins> (or <a href=https://en.wikipedia.org/wiki/CJK_characters>CJK</a>) fonts. Licenses for many fonts <em><strong>require</strong></em> subsetting such that they can’t be trivially copied from the output files generated from Matplotlib.</p><h2 id=font-fallback>Font Fallback</h2><p>Matplotlib was designed to work with a single font at runtime. A user <em>could</em> specify a <code>font.family</code>, which was supposed to correspond to <a href=https://www.w3schools.com/cssref/pr_font_font-family.asp>CSS</a> properties, but that was only used to find a <em>single</em> font present on the user's system.</p><p>Once that font was found (which is almost always found, since Matplotlib ships with a set of default fonts), all the user text was rendered only through that font. (which used to give out &ldquo;<ins>tofu</ins>&rdquo; if a character wasn't found)</p><hr><p>It might seem like an <em>outdated</em> approach for text rendering, now that we have these concepts like font-fallback, <ins>but these concepts weren't very well discussed in early 2000s</ins>. Even getting a single font to work <em>was considered a hard engineering problem</em>.</p><p>This was primarily because of the lack of <strong>any standardization</strong> for representation of fonts (Adobe had their own font representation, and so did Apple, Microsoft, etc.)</p><table><thead><tr><th><img src=https://user-images.githubusercontent.com/43996118/128605750-9d76fa4a-ce57-45c6-af23-761334d48ef7.png alt=Previous></th><th><img src=https://user-images.githubusercontent.com/43996118/128605746-9f79ebeb-c03d-407e-9e27-c3203a210908.png alt=After></th></tr></thead></table><p align=middle><ins>Previous</ins> (notice <i>Tofus</i>) VS <ins>After</ins> (CJK font as fallback)</p><p>To migrate from a font-first approach to a text-first approach, there are multiple steps involved:</p><h3 id=parsing-the-whole-font-family>Parsing the whole font family</h3><p>The very first (and crucial!) step is to get to a point where we have multiple font paths (ideally individual font files for the whole family). That is achieved with either:</p><ul><li><a href=https://github.com/matplotlib/matplotlib/pull/20496>PR: [with findfont diff] Parsing all families in font_manager</a>, or</li><li><a href=https://github.com/matplotlib/matplotlib/pull/20549>PR: [without findfont diff] Parsing all families in font_manager</a></li></ul><p>Quoting one of my <a href=https://matplotlib.org/matplotblog/posts/gsoc_2021_prequarter/>previous</a> blogs:</p><blockquote><p>Don’t break, a lot at stake!</p></blockquote><p>My first approach was to change the existing public <code>findfont</code> API to incorporate multiple filepaths. Since Matplotlib has a <em>very huge</em> userbase, there's a high chance it would break a chunk of people's workflow:</p><p align=center><img src=https://user-images.githubusercontent.com/43996118/129636132-47b141b3-f149-49b7-b0c0-67c256bd6ee1.png alt=FamilyParsingFlowChart width=60%>
First PR (left), Second PR (right)</p><h3 id=ft2font-overhaul>FT2Font Overhaul</h3><p>Once we get a list of font paths, we need to change the internal representation of a &ldquo;font&rdquo;. Matplotlib has a utility called FT2Font, which is written in C++, and used with wrappers as a Python extension, which in turn is used throughout the backends. For all intents and purposes, it used to mean: <code>FT2Font === SingleFont</code> (if you're interested, here's a <a href=https://user-images.githubusercontent.com/43996118/128352387-76a3f52a-20fc-4853-b624-0c91844fc785.png>meme</a> about how FT2Font was named!)</p><p>But that is not the case anymore, here's a flowchart to explain what happens now:</p><p align=center><img src=https://user-images.githubusercontent.com/43996118/129720023-14f5d67f-f279-433f-ad78-e5eccb6c784a.png alt=FamilyParsingFlowChart width=100%>
Font-Fallback Algorithm</p><p>With <a href=https://github.com/matplotlib/matplotlib/pull/20740>PR: Implement Font-Fallback in Matplotlib</a>, every FT2Font object has a <code>std::vector&lt;FT2Font *> fallback_list</code>, which is used for filling the parent cache, as can be seen in the self-explanatory flowchart.</p><p>For simplicity, only one type of cache (<ins>character -> FT2Font</ins>) is shown, whereas in actual implementation there's 2 types of caches, one shown above, and another for glyphs (<ins>glyph_id -> FT2Font</ins>).</p><blockquote><p>Note: Only the parent's APIs are used in some backends, so for each of the individual public functions like <code>load_glyph</code>, <code>load_char</code>, <code>get_kerning</code>, etc., we find the FT2Font object which has that glyph from the parent FT2Font cache!</p></blockquote><h3 id=multi-font-embedding-in-pdfpseps>Multi-Font embedding in PDF/PS/EPS</h3><p>Now that we have multiple fonts to render a string, we also need to embed them for those special backends (i.e., PDF/PS, etc.). This was done with some patches to specific backends:</p><ul><li><a href=https://github.com/matplotlib/matplotlib/pull/20804>PR: Implement multi-font embedding for PDF Backend</a></li><li><a href=https://github.com/matplotlib/matplotlib/pull/20832>PR: Implement multi-font embedding for PS Backend</a></li></ul><p>With this, one could create a PDF or a PS/EPS document with multiple fonts which are embedded (and subsetted!).</p><h2 id=conclusion>Conclusion</h2><p>From small contributions to eventually working on a core module of such a huge library, the road was not what I had imagined, and I learnt a lot while designing solutions to these problems.</p><h4 id=the-work-i-did-would-eventually-end-up-affecting-every-single-matplotlib-user>The work I did would eventually end up affecting every single Matplotlib user.</h4><p>&mldr;since all plots will work their way through the new codepath!</p><p>I think that single statement is worth the <ins>whole GSoC project</ins>.</p><h3 id=pull-request-statistics>Pull Request Statistics</h3><p>For the sake of statistics (and to make GSoC sound a bit less intimidating), here's a list of contributions I made to Matplotlib <ins>before Summer &lsquo;21</ins>, most of which are only a few lines of diff:</p><table><thead><tr><th align=center>Created At</th><th>PR Title</th><th align=center>Diff</th><th align=center>Status</th></tr></thead><tbody><tr><td align=center>Nov 2, 2020</td><td><a href=https://github.com/matplotlib/matplotlib/pull/18870>Expand ScalarMappable.set_array to accept array-like inputs</a></td><td align=center>(+28 −4)</td><td align=center>MERGED</td></tr><tr><td align=center>Nov 8, 2020</td><td><a href=https://github.com/matplotlib/matplotlib/pull/18916>Add overset and underset support for mathtext</a></td><td align=center>(+71 −0)</td><td align=center>MERGED</td></tr><tr><td align=center>Nov 14, 2020</td><td><a href=https://github.com/matplotlib/matplotlib/pull/18947>Strictly increasing check with test coverage for streamplot grid</a></td><td align=center>(+54 −2)</td><td align=center>MERGED</td></tr><tr><td align=center>Jan 11, 2021</td><td><a href=https://github.com/matplotlib/matplotlib/pull/19271>WIP: Add support to edit subplot configurations via textbox</a></td><td align=center>(+51 −11)</td><td align=center>DRAFT</td></tr><tr><td align=center>Jan 18, 2021</td><td><a href=https://github.com/matplotlib/matplotlib/pull/19314>Fix over/under mathtext symbols</a></td><td align=center>(+7,459 −4,169)</td><td align=center>MERGED</td></tr><tr><td align=center>Feb 11, 2021</td><td><a href=https://github.com/matplotlib/matplotlib/pull/19497>Add overset/underset whatsnew entry</a></td><td align=center>(+28 −17)</td><td align=center>MERGED</td></tr><tr><td align=center>May 15, 2021</td><td><a href=https://github.com/matplotlib/matplotlib/pull/20235>Warn user when mathtext font is used for ticks</a></td><td align=center>(+28 −0)</td><td align=center>MERGED</td></tr></tbody></table><p>Here's a list of PRs I opened <ins>during Summer'21</ins>:</p><ul><li>[Status: ✅] <a href=https://github.com/matplotlib/matplotlib/pull/20346>Clarify/Improve docs on family-names vs generic-families</a></li><li>[Status: ✅] <a href=https://github.com/matplotlib/matplotlib/pull/20367>Add parse_math in Text and default it False for TextBox</a></li><li>[Status: ✅] <a href=https://github.com/matplotlib/matplotlib/pull/20391>Type42 subsetting in PS/PDF</a></li><li>[Status: ✅] <a href=https://github.com/matplotlib/matplotlib/pull/20450>[Doc] Font Types and Font Subsetting</a></li><li>[Status: 🚧] <a href=https://github.com/matplotlib/matplotlib/pull/20496>[with findfont diff] Parsing all families in font_manager</a></li><li>[Status: 🚧] <a href=https://github.com/matplotlib/matplotlib/pull/20549>[without findfont diff] Parsing all families in font_manager</a></li><li>[Status: 🚧] <a href=https://github.com/matplotlib/matplotlib/pull/20740>Implement Font-Fallback in Matplotlib</a></li><li>[Status: 🚧] <a href=https://github.com/matplotlib/matplotlib/pull/20804>Implement multi-font embedding for PDF Backend</a></li><li>[Status: 🚧] <a href=https://github.com/matplotlib/matplotlib/pull/20832>Implement multi-font embedding for PS Backend</a></li></ul><h2 id=acknowledgements>Acknowledgements</h2><p>From learning about software engineering fundamentals from <a href=https://github.com/tacaswell>Tom</a> to learning about nitty-gritty details about font representations from <a href=https://github.com/jkseppan>Jouni</a>;</p><p>From learning through <a href=https://github.com/anntzer>Antony</a>&lsquo;s patches and pointers to receiving amazing feedback on these blogs from <a href=https://github.com/story645>Hannah</a>, it has been an adventure! 💯</p><p><em>Special Mentions: <a href=https://github.com/sauerburger>Frank</a>, <a href=https://github.com/srijan-paul>Srijan</a> and <a href=https://github.com/tfidfwastaken>Atharva</a> for their helping hands!</em></p><p>And lastly, <em>you</em>, the reader; if you've been following my <a href=https://matplotlib.org/matplotblog/categories/gsoc/>previous blogs</a>, or if you've landed at this one directly, I thank you nevertheless. (one last <a href=https://user-images.githubusercontent.com/43996118/126441988-5a2067fd-055e-44e5-86e9-4dddf47abc9d.png>meme</a>, I promise!)</p><p>I know I speak for every developer out there, when I say <ins><em><strong>it means a lot</strong></em></ins> when you choose to look at their journey or their work product; it could as well be a tiny website, or it could be as big as designing a complete library!</p><hr><blockquote><p>I'm grateful to <a href=https://matplotlib.org/>Maptlotlib</a> (under the parent organisation: <a href=https://numfocus.org/>NumFOCUS</a>), and of course, <a href=https://summerofcode.withgoogle.com/>Google Summer of Code</a> for this incredible learning opportunity.</p></blockquote><p>Farewell, reader! :')</p><p align=center><img src=https://user-images.githubusercontent.com/43996118/118876008-5e6dd580-b90a-11eb-96db-0abc930c6993.png alt=MatplotlibGSoC>
Consider contributing to Matplotlib (Open Source in general) ❤️</p><h4 id=note-this-blog-post-is-also-available-at-my-personal-websitehttpsaitikguptagithubiogsoc-final>NOTE: This blog post is also available at my <a href=https://aitikgupta.github.io/gsoc-final/>personal website</a>.</h4></article></main><nav class="end-nav side-padding"></nav><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous onload=renderMathInElement(document.body);></script><script src=https://matplotlib.org/matplotblog/js/core.min.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>